<div class="flex h-screen bg-white dark:bg-gray-900">
  <!-- Sidebar -->
  <div class="w-80 border-r border-gray-200 dark:border-gray-700 flex flex-col bg-white dark:bg-gray-900 sidenav-panel"
  >
    <!-- Header -->
    <div class="p-4 border-b border-gray-200 dark:border-gray-700 chat-header">
      <div class="flex items-center justify-between mb-4">
        <h1 class="text-xl font-semibold text-gray-900 dark:text-white">
          {{'MESSAGES.MESSAGES' | translate}}
        </h1>
      </div>
      <div class="relative" *ngIf="!isAdmin">
        <svg
          class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 dark:text-gray-500 w-4 h-4"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="m21 21-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
          ></path>
        </svg>
        <input
          type="text"
          placeholder="Search"
          (input)="onSearchChange($event)"
          class="w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400"
        />
      </div>

      <div class="relative flex align-items-center mb-2" *ngIf="isAdmin">
          <p class="mb-0 mr-10 flex-1">Vendor</p>       
          <mat-form-field appearance="outline" class="flex-2">
            <svg
              class="absolute left-3 top-20 transform -translate-y-1/2 text-gray-400 dark:text-gray-500 w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="m21 21-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
              ></path>
            </svg>
            <input type="text" matInput [formControl]="vendorSearchControl" [matAutocomplete]="auto" placeholder="Search" class="pl-35">
            <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayFn">
              @for (option of filteredVendorOptions | async; track option) {
                <mat-option [value]="option">{{option.name}}</mat-option>
              }
            </mat-autocomplete>
          </mat-form-field>
      </div>

      <div class="relative flex align-items-center" *ngIf="isAdmin">
          <p class="mb-0 mr-10 flex-1">Customer</p>       
          <mat-form-field appearance="outline" class="flex-2">
            <svg
              class="absolute left-3 top-20 transform -translate-y-1/2 text-gray-400 dark:text-gray-500 w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="m21 21-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
              ></path>
            </svg>
            <input type="text" matInput [formControl]="customerSearchControl" [matAutocomplete]="auto" placeholder="Search" class="pl-35">
            <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayFn">
              @for (option of filteredCustomerOptions | async; track option) {
                <mat-option [value]="option">{{option.name}}</mat-option>
              }
            </mat-autocomplete>
          </mat-form-field>
      </div>

      <div class="relative mt-3" *ngIf="isAdmin">
        <svg
          class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 dark:text-gray-500 w-4 h-4"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="m21 21-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
          ></path>
        </svg>
        <input
          type="text"
          placeholder="Search"
          (input)="onSearchChange($event)"
          class="w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400"
        />
      </div>
    </div>

    <!-- Conversations -->
    <!-- Vendor & Customer -->
    <div class="flex-1 overflow-y-auto relative" *ngIf="!isAdmin">
      <div class="spinner mr-2" *ngIf="loadingConversations"></div>
      <div
        *ngFor="let conv of filteredConversations; let i = index"
        (click)="selectChat(i)"
        [class]="
          'p-4 border-b border-gray-100 dark:border-gray-700 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 ' +
          (selectedChatIndex === i
            ? 'bg-blue-50 dark:bg-blue-900/20 border-r-2 border-r-blue-500'
            : '')
        "
      >
        <div class="flex flex-wrap items-start space-x-3">
          <div (click)="triggerMessagesMobile()" matTooltip="{{ transform(conv.vendor.firstName) }} {{ transform(conv.vendor.lastName) }}" *ngIf="isAdmin"
            [class]="
              'w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-medium flex-shrink-0 ' +
              mapLetterToElement(conv.vendor.firstName)
            ">
            {{ transform(conv.vendor.firstName) }} {{ transform(conv.vendor.lastName) }}
          </div>
          <div (click)="triggerMessagesMobile()" matTooltip="{{ transform(conv.submission.user.firstName) }} {{ transform(conv.submission.user.lastName) }}"
            [class]="
              'w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-medium flex-shrink-0 ' +
              mapLetterToElement(conv.submission.user.firstName)
            ">
            {{ transform(conv.submission.user.firstName) }} {{ transform(conv.submission.user.lastName) }}
          </div>
          <div class="flex-1 min-w-0">
            <div class="flex items-center justify-between">
              <h3 class="font-medium text-gray-900 dark:text-white truncate" matTooltip="{{ conv.title }}" (click)="triggerMessagesMobile()">
                {{ conv.title }}
              </h3>
              <div class="flex">
                <!-- <div class="text-xs text-gray-500 dark:text-gray-400 min-width-50 align-right ml-2">
                  {{ conv.time }}
                </div> -->
                <svg
                  [matMenuTriggerFor]="menu"
                  class="w-5 h-5 text-gray-500 dark:text-gray-400 cursor-pointer"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"
                  ></path>
                </svg>
                <mat-menu #menu="matMenu">
                  <div class="p-3" [ngClass]="isDarkMode ? 'bg-dark' : 'bg-light'">
                    <button mat-menu-item>
                      <i class="ki-outline ki-sms text-base me-1 mr-2"></i>
                      <span class="text-sm">{{'MESSAGES.MARK_AS_READ' | translate}}</span>
                    </button>
                    <button mat-menu-item>
                      <i class="ki-outline ki-archive-tick text-base me-1 mr-2"></i>
                      <span class="text-sm">{{'MESSAGES.ARCHIVE' | translate}}</span>
                    </button>
                  </div>
                </mat-menu>
              </div>
            </div>
          </div>
          <div class="w-100 m-0" [ngClass]="{'pl-42': !isAdmin}">
            <p class="text-sm text-gray-600 dark:text-gray-300 mt-1" (click)="triggerMessagesMobile()">
              {{ conv.submission.title }}
            </p>
            <!-- <p class="text-sm text-gray-500 dark:text-gray-400 mt-1 truncate" (click)="triggerMessagesMobile()">
              {{ conv.lastMessage }}
            </p> -->
          </div>
        </div>

        <!-- <div
          *ngIf="conv.hasIndicator"
          class="flex items-center justify-end mt-2"
        >
          <div class="w-2 h-2 bg-green-500 rounded-full"></div>
        </div> -->
      </div>
    </div>
    <!-- Admin -->
    <div class="flex-1 overflow-y-auto relative" *ngIf="isAdmin">
      <div class="spinner mr-2" *ngIf="loadingConversations"></div>
      <div
        *ngFor="let conv of filteredAdminConversations; let i = index"
        (click)="selectChat(i)"
        [class]="
          'p-4 border-b border-gray-100 dark:border-gray-700 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 ' +
          (selectedChatIndex === i
            ? 'bg-blue-50 dark:bg-blue-900/20 border-r-2 border-r-blue-500'
            : '')
        "
      >
        <div class="flex flex-wrap items-start space-x-3">
          <div (click)="triggerMessagesMobile()" matTooltip="{{ transform(conv.vendor.firstName) }} {{ transform(conv.vendor.lastName) }}" *ngIf="isAdmin"
            [class]="
              'w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-medium flex-shrink-0 ' +
              mapLetterToElement(conv.vendor.firstName)
            ">
            {{ transform(conv.vendor.firstName) }} {{ transform(conv.vendor.lastName) }}
          </div>
          <div (click)="triggerMessagesMobile()" matTooltip="{{ transform(conv.vendor.firstName) }} {{ transform(conv.vendor.lastName) }}"
            [class]="
              'w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-medium flex-shrink-0 ' +
              mapLetterToElement(conv.vendor.firstName)
            ">
            {{ transform(conv.submission.user.firstName) }} {{ transform(conv.submission.user.lastName) }}
          </div>
          <div class="flex-1 min-w-0">
            <div class="flex items-center justify-between">
              <h3 class="font-medium text-gray-900 dark:text-white truncate" [matTooltip]="conv.title" (click)="triggerMessagesMobile()">
                {{ conv.title }}
              </h3>
              <div class="flex">
                <!-- <div class="text-xs text-gray-500 dark:text-gray-400 min-width-50 align-right ml-2">
                  {{ conv.time }}
                </div> -->
                <svg
                  [matMenuTriggerFor]="menu"
                  class="w-5 h-5 text-gray-500 dark:text-gray-400 cursor-pointer"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"
                  ></path>
                </svg>
                <mat-menu #menu="matMenu">
                  <div class="p-3" [ngClass]="isDarkMode ? 'bg-dark' : 'bg-light'">
                    <button mat-menu-item>
                      <i class="ki-outline ki-sms text-base me-1 mr-2"></i>
                      <span class="text-sm">{{'MESSAGES.MARK_AS_READ' | translate}}</span>
                    </button>
                    <button mat-menu-item>
                      <i class="ki-outline ki-archive-tick text-base me-1 mr-2"></i>
                      <span class="text-sm">{{'MESSAGES.ARCHIVE' | translate}}</span>
                    </button>
                  </div>
                </mat-menu>
              </div>
            </div>
          </div>
          <div class="w-100 m-0" [ngClass]="{'pl-42': !isAdmin}">
            <p class="text-sm text-gray-600 dark:text-gray-300 mt-1" (click)="triggerMessagesMobile()">
              {{ conv.submission.title }}
            </p>
            <!-- <p class="text-sm text-gray-500 dark:text-gray-400 mt-1 truncate" (click)="triggerMessagesMobile()">
              {{ conv.title }}
            </p> -->
          </div>
        </div>
      </div>
    </div>

    <!-- Empty data -->
    <div
      *ngIf="!loadingConversations && filteredConversations.length === 0 && filteredAdminConversations.length === 0"
      class="flex items-start justify-center h-full text-gray-500 dark:text-gray-400 pt-10">
          <i class="ki-outline ki-messages text-base me-1 mr-2 fs-24"></i>
          <span class="text-sm">{{'MESSAGES.NO_CONVERSATIONS_FOUND' | translate}}</span>
    </div>

  </div>

  <!-- Main Chat Area -->
  <div class="flex-1 flex flex-col bg-white dark:bg-gray-900 messages-panel" [@messagesSidenavMobile]="sidenavTrigger">
    <!-- Chat Header -->
    <div  
      class="p-4 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900"
    >
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div *ngIf="selectedConversation"
            [class]="
              'w-10 h-10 rounded-full flex items-center justify-center text-white text-sm font-medium ' +
              mapLetterToElement(selectedConversation.vendor.firstName)
            "
          >
            {{ transform(selectedConversation.vendor.firstName) }} {{ transform(selectedConversation.vendor.lastName) }}
          </div>
          <div *ngIf="selectedConversation">
            <h2 class="font-semibold text-gray-900 dark:text-white">
              {{ selectedConversation.submission.title }}
            </h2>
            <p class="text-sm text-gray-500 dark:text-gray-400">
              {{ selectedConversation.title }}
            </p>
          </div>
        </div>
        <div class="flex items-center space-x-2">
          <svg
            (click)="removeConversation()"
            class="w-5 h-5 text-gray-500 dark:text-gray-400 cursor-pointer"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
            ></path>
          </svg>
          <i class="ki-outline ki-abstract-11 cursor-pointer text-base me-1 mr-2" (click)="sidenavTrigger = 'out'"></i>
        </div>
      </div>
      <div class="flex items-center space-x-4 mt-2 text-sm">
        <span class="text-gray-500 dark:text-gray-400"
          >ðŸŸ¢ 2:16 PM GMT+1 (1 h behind)</span
        >
      </div>
    </div>

    <!-- Messages -->
    <div class="flex-1 overflow-y-auto p-4 space-y-4 relative messages-section">
      <div class="spinner mr-2" *ngIf="loadingChatMessages"></div>
      <div
        *ngFor="let msg of currentMessages"
        class="flex items-start space-x-3"
          [ngClass]="msg.isUser ? 'dir-rtl' : 'dir-ltr'"
      >
        <div
          [class]="
            'w-8 h-8 rounded-full flex items-center justify-center text-white text-xs font-medium flex-shrink-0 ' +
            msg.bgColor
          "
        >
          {{ transform(msg.sender) }}
        </div>
        <div class="flex-1">
          <div class="flex items-center space-x-2 mb-1">
            <span class="font-medium text-gray-900 dark:text-white mr-10"
              >{{ msg.sender }}</span
            >
            <span class="text-xs text-gray-500 dark:text-gray-400 mr-10"
              >{{ msg.time }}</span
            >
          </div>
          <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-3 max-w-2xl mr-10">
            <p class="text-gray-800 dark:text-gray-200">{{ msg.content }}</p>
          </div>
          <div
            *ngIf="msg.hasPreview"
            class="mt-2 border border-gray-200 dark:border-gray-700 rounded-lg p-3 max-w-md bg-white dark:bg-gray-800"
          >
            <h4 class="font-medium text-gray-900 dark:text-white">
              {{ msg.preview?.title }}
            </h4>
            <p class="text-sm text-gray-600 dark:text-gray-300 mt-1">
              {{ msg.preview?.description }}
            </p>
            <span class="text-xs text-gray-500 dark:text-gray-400 mt-2 block"
              >{{ msg.preview?.platform }}</span
            >
          </div>
        </div>
      </div>
      <div class="text-sm text-gray-500 dark:text-gray-400 text-center py-2">
        Monday, Jul 28
      </div>
    </div>

    <!-- Message Input - Fixed height, no scrolling -->
    <div
      class="border-t border-gray-200 dark:border-gray-700 p-4 bg-white dark:bg-gray-900 relative"
    >
      <div 
        class="upload-files-panel bg-white dark:bg-gray-900"
        [ngStyle]="{
          height: uploadedFilesCount > 2 ? '150px' : '100px',
          top: uploadedFilesCount > 2 ? '-150px' : '-100px'
        }"
        *ngIf="showUploadFilesPanel"
      >
        <file-pond 
          #myPond 
          [options]="pondOptions" 
          [files]="pondFiles"
          (oninit)="pondHandleInit()"
          (onaddfile)="pondHandleAddFile($event)"
          (onremovefile)="onFileRemoved($event)"
          (onactivatefile)="pondHandleActivateFile($event)">
        </file-pond>
      </div>
      <div class="flex items-center space-x-3">
        <svg
          (click)="openFileUploadDialog()"
          class="w-5 h-5 text-gray-500 dark:text-gray-400 cursor-pointer mb-2"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="m18.375 12.739-7.693 7.693a4.5 4.5 0 0 1-6.364-6.364l10.94-10.94A3 3 0 1 1 19.5 7.372L8.552 18.32m.009-.01-.01.01m5.699-9.941-7.81 7.81a1.5 1.5 0 0 0 2.112 2.13"
          ></path>
        </svg>
        <div class="flex-1">
          <textarea
            placeholder="Send a message..."
            [(ngModel)]="newMessage"
            (keyup.enter)="sendMessage()"
            rows="1"
            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 resize-none overflow-hidden min-h-[40px] max-h-[120px]"
            style="height: auto"
          ></textarea>
        </div>
        <button
          (click)="sendMessage()"
          class="p-2 text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 mb-1"
        >
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Right Sidebar -->
  <div class="w-80 border-l border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 company-panel"
  >
    <!-- Profile Section -->
    <div
      class="p-6 bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700"
    >
      <div class="text-center" *ngIf="selectedConversation">
        <div
          [class]="
            'w-16 h-16 rounded-full mx-auto flex items-center justify-center text-white text-xl font-medium ' +
            mapLetterToElement(selectedConversation.vendor.firstName)
          "
        >
          {{ transform(selectedConversation.vendor.firstName) }} {{ transform(selectedConversation.vendor.lastName) }}
        </div>
        <h3 class="mt-3 text-lg font-semibold text-gray-900 dark:text-white">
          {{ selectedConversation.submission.title }}
        </h3>
        <p class="text-sm text-gray-600 dark:text-gray-300 mt-1">
          {{ selectedConversation.title }}
        </p>
      </div>
    </div>
  </div>
</div>
